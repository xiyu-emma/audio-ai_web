{% extends "base.html" %}

{% block title %}分析結果 - OceanAI{% endblock %}

{% block content %}
<div class="container-card">
    <div style="border-bottom: 1px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
        <h1>分析結果詳情</h1>
        <div style="color: var(--text-light); font-size: 0.95rem;">
            <p style="margin: 0.5rem 0;"><strong>原始檔案：</strong> {{ upload.original_filename }}</p>
            <p style="margin: 0.5rem 0;"><strong>分析時間：</strong> {{ upload.upload_timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
            <p style="margin: 0.5rem 0;"><strong>切片總數：</strong> {{ pagination.total }} 筆</p>
        </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <a href="{{ url_for('main.history') }}" class="btn btn-secondary">返回歷史紀錄</a>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">上傳新檔案</a>
        
        <a href="{{ url_for('main.download_dataset_zip', upload_id=upload.id) }}" class="btn btn-primary">
            下載訓練資料集
        </a>
        <a href="{{ url_for('main.labeling_page', upload_id=upload.id) }}" class="btn" style="background-color: #10b981; color: white;">
            進入標記模式
        </a>
    </div>

    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="80">編號</th>
                    <th width="120">起始時間</th>
                    <th>音訊片段</th>
                    <th>頻譜圖表</th>
                </tr>
            </thead>
            <tbody>
                {% for item in pagination.items %}
                <tr>
                    <td><strong>#{{ (pagination.page - 1) * pagination.per_page + loop.index }}</strong></td>
                    <td style="font-family: monospace; font-size: 1.1em; color: var(--primary-dark);">
                        {% set start_time = (loop.index0 + (pagination.page - 1) * pagination.per_page) * hop_length_seconds %}
                        {% set minutes = (start_time / 60) | int %}
                        {% set seconds = start_time % 60 %}
                        {{ "%02d:%06.3f" | format(minutes, seconds) }}
                    </td>
                    <td>
                        {% if item.audio_url %}
                        <audio controls controlsList="nodownload" style="width: 100%; max-width: 250px;">
                            <source src="{{ url_for('static', filename=item.audio_url) }}" type="audio/wav">
                            瀏覽器不支援播放
                        </audio>
                        {% else %}
                        <span style="color: #999; font-size: 0.9rem;">(無音訊)</span>
                        {% endif %}
                    </td>
                    <td>
                        <img src="{{ url_for('static', filename=item.spectrogram_url) }}" alt="頻譜圖" 
                             style="max-width: 300px; height: auto; border: 1px solid #eee; border-radius: 4px; padding: 2px;">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="display: flex; justify-content: center; gap: 5px; margin-top: 2rem;">
        {% if pagination.has_prev %}
            <a href="{{ url_for('main.results', upload_id=upload.id, page=pagination.prev_num) }}" class="btn btn-secondary" style="padding: 5px 12px;">上一頁</a>
        {% endif %}
        
        <span class="btn" style="background: white; color: var(--primary-dark); border: 1px solid #ddd; cursor: default;">
            第 {{ pagination.page }} 頁 / 共 {{ pagination.pages }} 頁
        </span>

        {% if pagination.has_next %}
            <a href="{{ url_for('main.results', upload_id=upload.id, page=pagination.next_num) }}" class="btn btn-secondary" style="padding: 5px 12px;">下一頁</a>
        {% endif %}
    </div>
</div>
{% endblock %}