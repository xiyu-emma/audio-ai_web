<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>標記模式 - {{ upload.original_filename }}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 2em; 
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1em;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #e9ecef; 
            padding-bottom: 1em; 
            background-color: #fff;
            padding: 1em 2em;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .nav-link a { 
            margin-right: 1em; 
            color: #007bff; 
            text-decoration: none; 
            font-weight: 500;
        }
        .nav-link a:hover { text-decoration: underline; }
        
        .label-manager { 
            background-color: #fff; 
            padding: 1.5em; 
            border-radius: 8px; 
            margin-top: 1.5em; 
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .label-manager h3 { margin-top: 0; }
        .label-manager input[type="text"] {
             padding: 8px; 
             border: 1px solid #ccc; 
             border-radius: 4px;
             margin-right: 5px;
        }
        .label-manager button {
            padding: 8px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .label-manager button:hover { background-color: #0056b3; }

        .label-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; margin-top: 1em; }
        .label-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.5em; border-bottom: 1px solid #eee; }
        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
        
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2em; margin-top: 2em; }
        .grid-item { border: 1px solid #dee2e6; border-radius: 8px; padding: 1em; text-align: center; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: box-shadow 0.2s; }
        .grid-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .grid-item img { max-width: 100%; height: auto; margin-bottom: 1em; border-radius: 4px; }
        .grid-item select { width: 100%; padding: 8px; border-radius: 4px; border-color: #ccc; }
        .status { font-size: 0.8em; color: green; height: 1em; margin-top: 0.5em; font-weight: bold; }
        
        .pagination { margin: 2em 0; text-align: center; }
        .pagination a, .pagination span { display: inline-block; padding: 8px 16px; margin: 0 4px; border: 1px solid #ddd; color: #007bff; text-decoration: none; border-radius: 4px; }
        .pagination a:hover { background-color: #e9ecef; }
        .pagination .current { background-color: #007bff; color: white; border-color: #007bff; }
        .pagination .disabled { color: #6c757d; border-color: #ddd; }
    </style>
</head>
<body>

<div class="container">

    <div class="header">
        <div>
            <h1>標記模式</h1>
            <p><strong>分析任務 ID: {{ upload.id }}</strong> ({{ upload.original_filename }})</p>
        </div>
        <div class="nav-link">
            <a href="{{ url_for('main.results', upload_id=upload.id) }}">&larr; 返回結果頁面</a>
            <a href="{{ url_for('main.history') }}">返回歷史紀錄</a>
        </div>
    </div>

    <div class="label-manager">
        <h3>管理分類標籤</h3>
        <div>
            <input type="text" id="new-label-name" placeholder="輸入新標籤名稱">
            <button onclick="addLabel()">新增標籤</button>
            <button onclick="downloadCSV()" style="background-color: #28a745; margin-left: 10px;">下載CSV檔案</button>
        </div>
        <ul id="label-list" class="label-list"></ul>
    </div>

    <!-- AI 自動標記功能區塊 -->
    <div class="label-manager" id="auto-label-section">
        <h3>AI 自動標記</h3>
        <p>上傳一個預先訓練好的模型 (.pt 或 .h5 檔案)，系統將自動為此任務中的所有圖片進行預測標記。</p>
        <form id="auto-label-form" method="POST" action="{{ url_for('main.auto_label') }}" enctype="multipart/form-data">
            <input type="hidden" name="upload_id" value="{{ upload.id }}">
            <div>
                <input type="file" name="model_file" accept=".pt,.h5" required>
            </div>
            <div style="margin-top: 1em;">
                <button type="submit">開始自動標記</button>
            </div>
        </form>
        <div id="loading-indicator" style="display: none; margin-top: 1em; font-weight: bold; color: #007bff;">
            模型上傳中，正在啟動背景標記任務... 請稍後刷新頁面查看結果。
        </div>
    </div>

    <!-- 圖片網格 -->
    <div class="image-grid">
        {% for result in pagination.items %}
        <div class="grid-item">
            <img src="{{ url_for('static', filename=result.spectrogram_training_url) }}" alt="Spectrogram {{ result.id }}">
            <select id="select-{{ result.id }}" onchange="updateLabel({{ result.id }}, this.value)">
                <option value="">-- 請選擇標籤 --</option>
            </select>
            <div id="status-{{ result.id }}" class="status"></div>
        </div>
        {% endfor %}
    </div>

    <!-- 分頁導覽列 -->
    <div class="pagination">
        {% if pagination.has_prev %}
            <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=pagination.prev_num) }}">&laquo; 上一頁</a>
        {% else %}
            <span class="disabled">&laquo; 上一頁</span>
        {% endif %}

        <span class="current">第 {{ pagination.page }} / {{ pagination.pages }} 頁</span>

        {% if pagination.has_next %}
            <a href="{{ url_for('main.labeling_page', upload_id=upload.id, page=pagination.next_num) }}">下一頁 &raquo;</a>
        {% else %}
            <span class="disabled">下一頁 &raquo;</span>
        {% endif %}
    </div>

</div>

<script>
    let allLabels = [];
    
    const resultsData = [
        {% for result in pagination.items %}
            { "id": {{ result.id }}, "label_id": {{ result.label_id or 'null' }} }
            {{ "," if not loop.last else "" }}
        {% endfor %}
    ];

    async function fetchAndRenderLabels() {
        try {
            const response = await fetch('/api/labels');
            if (!response.ok) throw new Error('無法獲取標籤');
            allLabels = await response.json();
            renderLabelList();
            populateAllDropdowns();
        } catch (error) {
            console.error('獲取標籤失敗:', error);
        }
    }

    async function addLabel() {
        const inputElement = document.getElementById('new-label-name');
        const name = inputElement.value.trim();
        if (!name) { alert('標籤名稱不可為空！'); return; }
        try {
            const response = await fetch('/api/labels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || '新增標籤失敗');
            }
            inputElement.value = '';
            fetchAndRenderLabels();
        } catch (error) {
            console.error('新增標籤錯誤:', error);
            alert(`新增標籤失敗：${error.message}`);
        }
    }

    async function deleteLabel(labelId, labelName) {
        if (!confirm(`您確定要刪除標籤 "${labelName}" 嗎？\n所有使用此標籤的圖片標記將會被清除。`)) { return; }
        try {
            const response = await fetch(`/api/labels/${labelId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('刪除標籤失敗');
            window.location.reload();
        } catch (error) {
            console.error('刪除標籤錯誤:', error);
            alert('刪除標籤失敗。');
        }
    }

    async function updateLabel(resultId, labelId) {
        const statusElement = document.getElementById(`status-${resultId}`);
        statusElement.textContent = '儲存中...';
        statusElement.style.color = 'orange';
        try {
            const response = await fetch(`/api/results/${resultId}/label`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ label_id: labelId ? parseInt(labelId) : null })
            });
            if (!response.ok) throw new Error('更新失敗');
            statusElement.textContent = '已儲存！';
            statusElement.style.color = 'green';
            setTimeout(() => { statusElement.textContent = ''; }, 2000);
        } catch (error) {
            console.error('更新標籤錯誤:', error);
            statusElement.textContent = '儲存失敗！';
            statusElement.style.color = 'red';
        }
    }

    function downloadCSV() {
        const uploadId = {{ upload.id }};
        const url = `/labeling/${uploadId}/download_csv`;
        
        // 創建一個隱藏的連結來觸發下載
        const link = document.createElement('a');
        link.href = url;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function renderLabelList() {
        const listElement = document.getElementById('label-list');
        listElement.innerHTML = '';
        allLabels.forEach(label => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${label.name} (ID: ${label.id})</span> <span class="delete-btn" onclick="deleteLabel(${label.id}, '${label.name}')">✖</span>`;
            listElement.appendChild(li);
        });
    }

    function populateAllDropdowns() {
        resultsData.forEach(result => {
            const selectElement = document.getElementById(`select-${result.id}`);
            if (!selectElement) return;
            const firstOption = selectElement.options[0];
            selectElement.innerHTML = '';
            selectElement.appendChild(firstOption);
            allLabels.forEach(label => {
                const option = document.createElement('option');
                option.value = label.id;
                option.textContent = label.name;
                if (result.label_id === label.id) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchAndRenderLabels();
        const autoLabelForm = document.getElementById('auto-label-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        if(autoLabelForm) {
            autoLabelForm.addEventListener('submit', () => {
                const fileInput = autoLabelForm.querySelector('input[type="file"]');
                if (fileInput.files.length > 0) {
                    loadingIndicator.style.display = 'block';
                }
            });
        }
    });
</script>

</body>
</html>

