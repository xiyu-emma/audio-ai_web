{% extends "base.html" %}

{% block title %}åˆ†ææ­·å²ç´€éŒ„ - OceanAI{% endblock %}

{% block content %}
<div class="container-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>åˆ†ææ­·å²ç´€éŒ„</h1>
        <div class="sort-options">
            <span style="color: var(--text-light); margin-right: 10px;">æ’åºï¼š</span>
            <a href="{{ url_for('main.history', sort='desc') }}"
                class="btn btn-sm {{ 'btn-secondary' if current_sort != 'desc' else 'btn-primary' }}"
                style="padding: 5px 12px; font-size: 0.9rem;">ç”±æ–°åˆ°èˆŠ</a>
            <a href="{{ url_for('main.history', sort='asc') }}"
                class="btn btn-sm {{ 'btn-secondary' if current_sort != 'asc' else 'btn-primary' }}"
                style="padding: 5px 12px; font-size: 0.9rem;">ç”±èˆŠåˆ°æ–°</a>
        </div>
    </div>

    <form id="history-form" method="post">
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
                        <th width="60">ID</th>
                        <th>åŸå§‹æª”æ¡ˆ</th>
                        <th>ç‹€æ…‹</th>
                        <th>åˆ†ææ™‚é–“</th>
                        <th>åƒæ•¸æ‘˜è¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for upload in uploads %}
                    <tr id="upload-row-{{ upload.id }}">
                        <td><input type="checkbox" name="upload_ids" value="{{ upload.id }}" class="upload-checkbox">
                        </td>
                        <td><strong>#{{ upload.id }}</strong></td>
                        <td>
                            <div style="font-weight: 500;">{{ upload.original_filename }}</div>
                        </td>
                        <td class="status-cell">
                            {% if upload.status == 'PROCESSING' %}
                            <div
                                style="width: 120px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; position: relative;">
                                <div class="progress-bar"
                                    style="width: {{ upload.progress }}%; background: var(--highlight); height: 100%; transition: width 0.4s;">
                                </div>
                            </div>
                            <small class="progress-text" style="color: var(--primary-med);">{{ upload.progress
                                }}%</small>
                            {% else %}
                            <span class="status-badge status-{{ upload.status }}">{{ upload.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ upload.upload_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% set p = upload.get_params() %}
                            <small style="color: #666;">
                                {{ p.spec_type }} | {{ p.segment_duration }}s | ov: {{ p.overlap }}%
                            </small>
                        </td>
                        <td class="action-cell">
                            {% if upload.status == 'COMPLETED' %}
                            <a href="{{ url_for('main.results', upload_id=upload.id) }}" class="btn btn-secondary"
                                style="padding: 4px 10px; font-size: 0.85rem;">æŸ¥çœ‹çµæœ</a>
                            {% else %}
                            <span style="color: #ccc; font-size: 0.85rem;">--</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: #999;">
                            å°šç„¡åˆ†æè³‡æ–™ï¼Œè«‹å…ˆå‰å¾€ã€Œä¸Šå‚³åˆ†æã€é é¢ã€‚
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
            <button type="button" class="btn" style="background: #20c997; color: white;"
                onclick="openTrainingModal()">å•Ÿå‹•æ¨¡å‹è¨“ç·´</button>
            <button type="button" class="btn btn-danger" onclick="submitDeletion()">åˆªé™¤é¸å–é …ç›®</button>
        </div>
    </form>

    <!-- è¨“ç·´è¨­å®šå½ˆçª— -->
    <div id="training-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ¯ è¨“ç·´è¨­å®š</h2>
                <button class="modal-close" onclick="closeTrainingModal()">&times;</button>
            </div>
            <form id="training-config-form" method="post" action="{{ url_for('main.start_training') }}">
                <div class="modal-body">
                    <!-- éš±è—æ¬„ä½ï¼šå„²å­˜é¸å–çš„ upload_ids -->
                    <div id="hidden-upload-ids"></div>

                    <!-- æ¨¡å‹é¸æ“‡ -->
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">é¸æ“‡æ¨¡å‹</label>
                        <div style="display: grid; gap: 0.75rem;">
                            <label class="model-option selected" onclick="selectModel(this)">
                                <input type="radio" name="model_type" value="yolov8n-cls" checked>
                                <div class="model-option-header">
                                    <span>ğŸš€</span> YOLOv8n åˆ†é¡
                                </div>
                                <div class="model-option-desc">è¼•é‡ç´šï¼Œè¨“ç·´å¿«é€Ÿï¼Œé©åˆå¿«é€Ÿå¯¦é©—</div>
                            </label>
                            <label class="model-option" onclick="selectModel(this)">
                                <input type="radio" name="model_type" value="yolov8s-cls">
                                <div class="model-option-header">
                                    <span>âš¡</span> YOLOv8s åˆ†é¡
                                </div>
                                <div class="model-option-desc">æ¨™æº–ç‰ˆï¼Œç²¾åº¦èˆ‡é€Ÿåº¦å¹³è¡¡</div>
                            </label>
                            <label class="model-option" onclick="selectModel(this)">
                                <input type="radio" name="model_type" value="resnet18">
                                <div class="model-option-header">
                                    <span>ğŸ§ </span> ResNet18
                                </div>
                                <div class="model-option-desc">ç¶“å…¸ CNN æ¶æ§‹ï¼Œç©©å®šå¯é </div>
                            </label>
                            <label class="model-option" onclick="selectModel(this)">
                                <input type="radio" name="model_type" value="efficientnet_b0">
                                <div class="model-option-header">
                                    <span>ğŸ’</span> EfficientNet-B0
                                </div>
                                <div class="model-option-desc">é«˜æ•ˆèƒ½ CNNï¼Œç²¾åº¦å„ªç§€</div>
                            </label>
                        </div>
                    </div>

                    <!-- è¨“ç·´åƒæ•¸ -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">è¨“ç·´åƒæ•¸</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="epochs">è¨“ç·´è¼ªæ•¸ (Epochs)</label>
                                <input type="number" id="epochs" name="epochs" value="50" min="1" max="500">
                            </div>
                            <div class="form-group">
                                <label for="batch_size">æ‰¹æ¬¡å¤§å° (Batch Size)</label>
                                <select id="batch_size" name="batch_size">
                                    <option value="8">8</option>
                                    <option value="16" selected>16</option>
                                    <option value="32">32</option>
                                    <option value="64">64</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="learning_rate">å­¸ç¿’ç‡ (Learning Rate)</label>
                                <select id="learning_rate" name="learning_rate">
                                    <option value="0.0001">0.0001</option>
                                    <option value="0.001" selected>0.001</option>
                                    <option value="0.01">0.01</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="image_size">åœ–ç‰‡å°ºå¯¸ (px)</label>
                                <select id="image_size" name="image_size">
                                    <option value="128">128</option>
                                    <option value="224" selected>224</option>
                                    <option value="256">256</option>
                                    <option value="320">320</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTrainingModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">é–‹å§‹è¨“ç·´</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="data-config" data-new-upload-id="{{ request.args.get('new_upload_id') }}"></div>

<script>
    // å…¨é¸/å–æ¶ˆå…¨é¸
    function toggleAll(source) {
        const checkboxes = document.getElementsByClassName('upload-checkbox');
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
    }

    // å–å¾—å·²é¸å–çš„ ID
    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.upload-checkbox:checked')).map(cb => cb.value);
    }

    // é–‹å•Ÿè¨“ç·´è¨­å®šå½ˆçª—
    function openTrainingModal() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('è«‹è‡³å°‘é¸å–ä¸€å€‹é …ç›®ä¾†é€²è¡Œè¨“ç·´ã€‚');
            return;
        }

        // å°‡é¸å–çš„ ID æ”¾å…¥éš±è—æ¬„ä½
        const hiddenContainer = document.getElementById('hidden-upload-ids');
        hiddenContainer.innerHTML = selectedIds.map(id =>
            `<input type="hidden" name="upload_ids" value="${id}">`
        ).join('');

        document.getElementById('training-modal').classList.add('active');
    }

    // é—œé–‰è¨“ç·´è¨­å®šå½ˆçª—
    function closeTrainingModal() {
        document.getElementById('training-modal').classList.remove('active');
    }

    // æ¨¡å‹é¸é …é¸å–æ•ˆæœ
    function selectModel(element) {
        document.querySelectorAll('.model-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
    }

    // é»æ“Š Modal å¤–éƒ¨é—œé–‰
    document.getElementById('training-modal').addEventListener('click', function (e) {
        if (e.target === this) closeTrainingModal();
    });

    // æäº¤åˆªé™¤
    function submitDeletion() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('è«‹è‡³å°‘é¸å–ä¸€å€‹é …ç›®é€²è¡Œåˆªé™¤ã€‚');
            return;
        }
        if (confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${selectedIds.length} å€‹é …ç›®å—ï¼Ÿæ‰€æœ‰ç›¸é—œæª”æ¡ˆå°‡è¢«æ°¸ä¹…ç§»é™¤ã€‚`)) {
            const form = document.getElementById('history-form');
            form.action = "{{ url_for('main.delete_selected_uploads') }}";
            form.submit();
        }
    }

    // å‹•æ…‹æ›´æ–°é‚è¼¯ (Polling)
    document.addEventListener('DOMContentLoaded', () => {
        const activeIntervals = new Map();
        const configDiv = document.getElementById('data-config');
        const newUploadId = configDiv ? configDiv.dataset.newUploadId : null;

        // å¦‚æœæ˜¯å‰›ä¸Šå‚³çš„æª”æ¡ˆï¼Œåˆå§‹åŒ–å®ƒçš„é€²åº¦æ¢é¡¯ç¤º
        if (newUploadId) {
            const newRow = document.getElementById(`upload-row-${newUploadId}`);
            if (newRow) {
                const statusCell = newRow.querySelector('.status-cell');
                const statusBadge = statusCell.querySelector('.status-badge');

                // å¦‚æœç‹€æ…‹æ˜¯ PENDINGï¼Œå…ˆæ‰‹å‹•æ›æˆé€²åº¦æ¢æ¨£å¼ï¼Œè®“ä½¿ç”¨è€…è¦ºå¾—æœ‰åæ‡‰
                if (statusBadge && statusBadge.textContent.trim() === 'PENDING') {
                    statusCell.innerHTML = `
                        <div style="width: 120px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; position: relative;">
                            <div class="progress-bar" style="width: 0%; background: var(--highlight); height: 100%; transition: width 0.4s;"></div>
                        </div>
                        <small class="progress-text" style="color: var(--primary-med);">0%</small>
                    `;
                }
                startPolling(newUploadId);
            }
        }

        // æƒæé é¢ä¸Šæ‰€æœ‰å¯èƒ½æœ‰é€²åº¦æ¢çš„è¡Œ
        const rowsToUpdate = document.querySelectorAll('tr[id^="upload-row-"]');
        rowsToUpdate.forEach(row => {
            const uploadId = row.id.split('-')[2];
            if (uploadId === newUploadId) return; // å·²ç¶“è™•ç†éäº†

            const statusCell = row.querySelector('.status-cell');
            if (statusCell.querySelector('.progress-bar')) {
                startPolling(uploadId);
            }
        });

        function startPolling(uploadId) {
            if (activeIntervals.has(uploadId)) return;

            const intervalId = setInterval(() => {
                fetch(`/api/upload/${uploadId}/status`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => updateRow(data))
                    .catch(error => {
                        console.error(`Error fetching status for upload ${uploadId}:`, error);
                        stopPolling(uploadId);
                    });
            }, 2000);

            activeIntervals.set(uploadId, intervalId);
        }

        function stopPolling(uploadId) {
            if (activeIntervals.has(uploadId)) {
                clearInterval(activeIntervals.get(uploadId));
                activeIntervals.delete(uploadId);
            }
        }

        function updateRow(data) {
            const row = document.getElementById(`upload-row-${data.id}`);
            if (!row) return;

            const statusCell = row.querySelector('.status-cell');

            if (data.status === 'PROCESSING' || data.status === 'PENDING') {
                // æ›´æ–°é€²åº¦æ¢
                let progressBar = statusCell.querySelector('.progress-bar');
                let progressText = statusCell.querySelector('.progress-text');

                // å¦‚æœåŸæœ¬æ²’æœ‰é€²åº¦æ¢ (ä¾‹å¦‚å‰›å¾ PENDING è®Š PROCESSING)ï¼Œéœ€è¦é‡å»º HTML
                if (!progressBar) {
                    statusCell.innerHTML = `
                        <div style="width: 120px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; position: relative;">
                            <div class="progress-bar" style="width: ${data.progress}%; background: var(--highlight); height: 100%; transition: width 0.4s;"></div>
                        </div>
                        <small class="progress-text" style="color: var(--primary-med);">${data.progress}%</small>
                    `;
                } else {
                    progressBar.style.width = `${data.progress}%`;
                    if (progressText) progressText.textContent = `${data.progress}%`;
                }
            } else {
                // ä»»å‹™çµæŸ (COMPLETED æˆ– FAILED)
                stopPolling(data.id);

                // æ›´æ–°ç‹€æ…‹æ¨™ç±¤
                statusCell.innerHTML = `<span class="status-badge status-${data.status}">${data.status}</span>`;

                // å¦‚æœæˆåŠŸï¼Œæ›´æ–°æ“ä½œæŒ‰éˆ•
                if (data.status === 'COMPLETED') {
                    const actionCell = row.querySelector('.action-cell');
                    // æ³¨æ„ï¼šé€™è£¡ç›´æ¥ä½¿ç”¨ HTML å­—ä¸²æ›¿æ›
                    actionCell.innerHTML = `<a href="/results/${data.id}" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.85rem;">æŸ¥çœ‹çµæœ</a>`;
                }
            }
        }
    });
</script>
{% endblock %}