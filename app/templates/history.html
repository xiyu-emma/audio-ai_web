{% extends "base.html" %}

{% block title %}分析歷史紀錄 - OceanAI{% endblock %}

{% block content %}
<div class="container-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>分析歷史紀錄</h1>
        <div class="sort-options">
            <span style="color: var(--text-light); margin-right: 10px;">排序：</span>
            <a href="{{ url_for('main.history', sort='desc') }}" class="btn btn-sm {{ 'btn-secondary' if current_sort != 'desc' else 'btn-primary' }}" style="padding: 5px 12px; font-size: 0.9rem;">由新到舊</a>
            <a href="{{ url_for('main.history', sort='asc') }}" class="btn btn-sm {{ 'btn-secondary' if current_sort != 'asc' else 'btn-primary' }}" style="padding: 5px 12px; font-size: 0.9rem;">由舊到新</a>
        </div>
    </div>

    <form id="history-form" method="post">
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
                        <th width="60">ID</th>
                        <th>原始檔案</th>
                        <th>狀態</th>
                        <th>分析時間</th>
                        <th>參數摘要</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for upload in uploads %}
                    <tr id="upload-row-{{ upload.id }}">
                        <td><input type="checkbox" name="upload_ids" value="{{ upload.id }}" class="upload-checkbox"></td>
                        <td><strong>#{{ upload.id }}</strong></td>
                        <td>
                            <div style="font-weight: 500;">{{ upload.original_filename }}</div>
                        </td>
                        <td class="status-cell">
                            {% if upload.status == 'PROCESSING' %}
                                <div style="width: 120px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; position: relative;">
                                    <div class="progress-bar" style="width: {{ upload.progress }}%; background: var(--highlight); height: 100%; transition: width 0.4s;"></div>
                                </div>
                                <small class="progress-text" style="color: var(--primary-med);">{{ upload.progress }}%</small>
                            {% else %}
                                <span class="status-badge status-{{ upload.status }}">{{ upload.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ upload.upload_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% set p = upload.get_params() %}
                            <small style="color: #666;">
                                {{ p.spec_type }} | {{ p.segment_duration }}s | ov: {{ p.overlap }}%
                            </small>
                        </td>
                        <td class="action-cell">
                            {% if upload.status == 'COMPLETED' %}
                                <a href="{{ url_for('main.results', upload_id=upload.id) }}" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.85rem;">查看結果</a>
                            {% else %}
                                <span style="color: #ccc; font-size: 0.85rem;">--</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: #999;">
                            尚無分析資料，請先前往「上傳分析」頁面。
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
            <button type="button" class="btn" style="background: #20c997; color: white;" onclick="submitTraining()">啟動模型訓練</button>
            <button type="button" class="btn btn-danger" onclick="submitDeletion()">刪除選取項目</button>
        </div>
    </form>
</div>

<div id="data-config" data-new-upload-id="{{ request.args.get('new_upload_id') }}"></div>

<script>
    // 全選/取消全選
    function toggleAll(source) {
        const checkboxes = document.getElementsByClassName('upload-checkbox');
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
    }

    // 取得已選取的 ID
    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.upload-checkbox:checked')).map(cb => cb.value);
    }

    // 提交訓練
    function submitTraining() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('請至少選取一個項目來進行訓練。');
            return;
        }
        const form = document.getElementById('history-form');
        form.action = "{{ url_for('main.start_training') }}";
        form.submit();
    }

    // 提交刪除
    function submitDeletion() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('請至少選取一個項目進行刪除。');
            return;
        }
        if (confirm(`您確定要刪除選取的 ${selectedIds.length} 個項目嗎？所有相關檔案將被永久移除。`)) {
            const form = document.getElementById('history-form');
            form.action = "{{ url_for('main.delete_selected_uploads') }}";
            form.submit();
        }
    }

    // 動態更新邏輯 (Polling)
    document.addEventListener('DOMContentLoaded', () => {
        const activeIntervals = new Map();
        const configDiv = document.getElementById('data-config');
        const newUploadId = configDiv ? configDiv.dataset.newUploadId : null;

        // 如果是剛上傳的檔案，初始化它的進度條顯示
        if (newUploadId) {
            const newRow = document.getElementById(`upload-row-${newUploadId}`);
            if (newRow) {
                const statusCell = newRow.querySelector('.status-cell');
                const statusBadge = statusCell.querySelector('.status-badge');

                // 如果狀態是 PENDING，先手動換成進度條樣式，讓使用者覺得有反應
                if (statusBadge && statusBadge.textContent.trim() === 'PENDING') {
                    statusCell.innerHTML = `
                        <div style="width: 120px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; position: relative;">
                            <div class="progress-bar" style="width: 0%; background: var(--highlight); height: 100%; transition: width 0.4s;"></div>
                        </div>
                        <small class="progress-text" style="color: var(--primary-med);">0%</small>
                    `;
                }
                startPolling(newUploadId);
            }
        }
        
        // 掃描頁面上所有可能有進度條的行
        const rowsToUpdate = document.querySelectorAll('tr[id^="upload-row-"]');
        rowsToUpdate.forEach(row => {
            const uploadId = row.id.split('-')[2];
            if (uploadId === newUploadId) return; // 已經處理過了

            const statusCell = row.querySelector('.status-cell');
            if (statusCell.querySelector('.progress-bar')) {
                startPolling(uploadId);
            }
        });

        function startPolling(uploadId) {
            if (activeIntervals.has(uploadId)) return;

            const intervalId = setInterval(() => {
                fetch(`/api/upload/${uploadId}/status`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => updateRow(data))
                    .catch(error => {
                        console.error(`Error fetching status for upload ${uploadId}:`, error);
                        stopPolling(uploadId);
                    });
            }, 2000); 

            activeIntervals.set(uploadId, intervalId);
        }

        function stopPolling(uploadId) {
            if (activeIntervals.has(uploadId)) {
                clearInterval(activeIntervals.get(uploadId));
                activeIntervals.delete(uploadId);
            }
        }

        function updateRow(data) {
            const row = document.getElementById(`upload-row-${data.id}`);
            if (!row) return;

            const statusCell = row.querySelector('.status-cell');
            
            if (data.status === 'PROCESSING' || data.status === 'PENDING') {
                // 更新進度條
                let progressBar = statusCell.querySelector('.progress-bar');
                let progressText = statusCell.querySelector('.progress-text');
                
                // 如果原本沒有進度條 (例如剛從 PENDING 變 PROCESSING)，需要重建 HTML
                if (!progressBar) {
                    statusCell.innerHTML = `
                        <div style="width: 120px; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; position: relative;">
                            <div class="progress-bar" style="width: ${data.progress}%; background: var(--highlight); height: 100%; transition: width 0.4s;"></div>
                        </div>
                        <small class="progress-text" style="color: var(--primary-med);">${data.progress}%</small>
                    `;
                } else {
                    progressBar.style.width = `${data.progress}%`;
                    if(progressText) progressText.textContent = `${data.progress}%`;
                }
            } else {
                // 任務結束 (COMPLETED 或 FAILED)
                stopPolling(data.id);
                
                // 更新狀態標籤
                statusCell.innerHTML = `<span class="status-badge status-${data.status}">${data.status}</span>`;
                
                // 如果成功，更新操作按鈕
                if (data.status === 'COMPLETED') {
                    const actionCell = row.querySelector('.action-cell');
                    // 注意：這裡直接使用 HTML 字串替換
                    actionCell.innerHTML = `<a href="/results/${data.id}" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.85rem;">查看結果</a>`;
                }
            }
        }
    });
</script>
{% endblock %}