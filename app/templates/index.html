{% extends "base.html" %}

{% block title %}éŸ³è¨Šä¸Šå‚³ - OceanAI{% endblock %}

{% block content %}
<div class="container-card" style="max-width: 700px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1>éŸ³è¨Šæª”æ¡ˆä¸Šå‚³</h1>
        <p style="color: var(--text-light);">è«‹ä¸Šå‚³æµ·æ´‹ç”Ÿç‰©éŒ„éŸ³æª” (.wav, .mp3)ï¼Œç³»çµ±å°‡è‡ªå‹•é€²è¡Œé »è­œåˆ†æã€‚</p>
    </div>

    <form method="post" action="{{ url_for('main.upload') }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="files">é¸æ“‡éŸ³è¨Šæª”æ¡ˆ (å¯å¤šé¸)</label>
            <input type="file" id="files" name="files" accept=".wav,.mp3" required multiple
                style="padding: 1rem; border: 2px dashed #cbd5e1; background: #f8fafc;">
            <div id="fileList" class="file-list-preview"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="form-group">
                <label for="sample_rate">å–æ¨£ç‡ (Sample Rate)</label>
                <select id="sample_rate" name="sample_rate">
                    <option value="None">ä½¿ç”¨åŸå§‹è¨­å®š</option>
                    <option value="4000">4,000 Hz</option>
                    <option value="16000">16,000 Hz</option>
                    <option value="32000">32,000 Hz</option>
                    <option value="64000">64,000 Hz</option>
                </select>
            </div>
            <div class="form-group">
                <label for="channels">è²é“ (Channels)</label>
                <select id="channels" name="channels">
                    <option value="mono">å–®è²é“ (Mono)</option>
                    <option value="stereo">é›™è²é“ (Stereo)</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="form-group">
                <label for="segment_duration">åˆ‡å‰²é•·åº¦ (ç§’)</label>
                <input type="number" id="segment_duration" name="segment_duration" step="0.1" value="2.0" required>
            </div>
            <div class="form-group">
                <label for="overlap">é‡ç–Šç‡ (%)</label>
                <input type="number" id="overlap" name="overlap" min="0" max="99" value="50" required>
            </div>
        </div>

        <div class="form-group">
            <label for="spec_type">é »è­œåœ–é¡å‹</label>
            <select id="spec_type" name="spec_type">
                <option value="mel">Mel Spectrogram (æ¢…çˆ¾é »è­œ)</option>
                <option value="yamnet_log_mel">YAMNet Log Mel</option>
                <option value="stft">STFT (çŸ­æ™‚è·å‚…ç«‹è‘‰)</option>
                <option value="classic_demon">DEMON äºŒç¶­é »è­œåœ–</option>
                <option value="envelope_spectrum">åŒ…çµ¡ç·šé »è­œåˆ†æ</option>
            </select>
        </div>

        <!-- é »è­œåœ–é€²éšåƒæ•¸è¨­å®š -->
        <div class="spectrogram-params-section" id="specParamsSection">
            <div class="params-header" onclick="toggleSpecParams()">
                <span class="params-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                    <span id="paramsHeaderTitle">é »è­œåœ–é€²éšåƒæ•¸</span>
                </span>
                <span class="params-toggle" id="toggleIcon">â–¼</span>
            </div>
            <div class="params-content" id="specParamsContent">
                <p class="params-description" id="paramsDescription">èª¿æ•´é »è­œåˆ†æçš„é€²éšåƒæ•¸ï¼Œå¯å½±éŸ¿é »è­œåœ–çš„è§£æåº¦èˆ‡ç²¾ç¢ºåº¦ã€‚</p>

                <!-- FFT Window Size & Hop Length - é©ç”¨æ–¼ mel, stft -->
                <div class="param-row" data-spec-types="mel,stft"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label for="n_fft">FFT Window Size (n_fft)</label>
                        <select id="n_fft" name="n_fft">
                            <option value="256">256</option>
                            <option value="512">512</option>
                            <option value="1024" selected>1024</option>
                            <option value="2048">2048</option>
                            <option value="4096">4096</option>
                        </select>
                        <span class="param-hint">è¼ƒå¤§å€¼æä¾›æ›´é«˜é »ç‡è§£æåº¦ï¼Œä½†æ™‚é–“è§£æåº¦è¼ƒä½</span>
                    </div>
                    <div class="form-group">
                        <label for="window_overlap">Window Overlap (çª—å£é‡ç–Šç‡ %)</label>
                        <input type="number" id="window_overlap" name="window_overlap" value="50" min="0" max="99"
                            step="1">
                        <span class="param-hint">å»ºè­°ç¯„åœ 25-90%ï¼Œè¼ƒé«˜é‡ç–Šç‡æä¾›æ›´å¹³æ»‘çš„æ™‚é–“è»¸</span>
                    </div>
                </div>

                <!-- Window Type - é©ç”¨æ–¼ mel, stft -->
                <div class="param-row" data-spec-types="mel,stft"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label for="window_type">Window Type (çª—å‡½æ•¸)</label>
                        <select id="window_type" name="window_type">
                            <option value="hann" selected>Hann (æ¼¢å¯§çª—)</option>
                            <option value="hamming">Hamming (æ¼¢æ˜çª—)</option>
                            <option value="blackman">Blackman (å¸ƒèŠå…‹æ›¼çª—)</option>
                            <option value="bartlett">Bartlett (å·´ç‰¹åˆ©ç‰¹çª—)</option>
                            <option value="kaiser">Kaiser (å‡±æ’’çª—)</option>
                            <option value="rectangular">Rectangular (çŸ©å½¢çª—)</option>
                        </select>
                        <span class="param-hint">ä¸åŒçª—å‡½æ•¸å½±éŸ¿é »è­œæ´©æ¼ç‰¹æ€§</span>
                    </div>

                    <!-- n_mels - åƒ…é©ç”¨æ–¼ mel -->
                    <div class="form-group" data-spec-types="mel">
                        <label for="n_mels">Mel æ¿¾æ³¢å™¨æ•¸é‡(n_mels)</label>
                        <select id="n_mels" name="n_mels">
                            <option value="40">40</option>
                            <option value="64">64</option>
                            <option value="80">80</option>
                            <option value="128" selected>128</option>
                            <option value="256">256</option>
                        </select>
                        <span class="param-hint">å½±éŸ¿ Mel é »ç‡è»¸è§£æåº¦</span>
                    </div>
                    <!-- Power - é©ç”¨æ–¼ mel å’Œ stft -->
                    <div class="form-group" data-spec-types="mel,stft">
                        <label for="power">åŠŸç‡æŒ‡æ•¸</label>
                        <select id="power" name="power">
                            <option value="1.0">1.0 (å¹…åº¦é »è­œ)</option>
                            <option value="2.0" selected>2.0 (åŠŸç‡é »è­œ)</option>
                        </select>
                        <span class="param-hint">1.0 ç‚ºå¹…åº¦é »è­œï¼Œ2.0 ç‚ºåŠŸç‡é »è­œ</span>
                    </div>
                </div>

                <!-- é »ç‡ç¯„åœ - é©ç”¨æ–¼ mel -->
                <div class="param-row" data-spec-types="mel"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label for="f_min">æœ€ä½é »ç‡ (Hz)</label>
                        <input type="number" id="f_min" name="f_min" value="0" min="0" step="10">
                        <span class="param-hint">é »è­œåˆ†æçš„æœ€ä½é »ç‡ç¯„åœ</span>
                    </div>
                    <div class="form-group">
                        <label for="f_max">æœ€é«˜é »ç‡ (Hz)</label>
                        <input type="number" id="f_max" name="f_max" value="0" min="0" step="100"
                            placeholder="é è¨­ç‚º sample_rate / 2">
                        <span class="param-hint">è¨­ç‚º 0 è¡¨ç¤ºä½¿ç”¨ Nyquist é »ç‡</span>
                    </div>
                </div>

                <!-- ç„¡å¯èª¿æ•´åƒæ•¸çš„æç¤º - é©ç”¨æ–¼ yamnet_log_mel, classic_demon, envelope_spectrum -->
                <div class="param-row no-params-notice"
                    data-spec-types="yamnet_log_mel,classic_demon,envelope_spectrum">
                    <div class="no-params-box">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span id="noParamsText">æ­¤é »è­œåœ–é¡å‹ä½¿ç”¨é è¨­åƒæ•¸ï¼Œç„¡éœ€é¡å¤–èª¿æ•´ã€‚</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <span style="font-size: 1.2rem;">é–‹å§‹åˆ†æ</span>
            </button>
        </div>
    </form>
</div>

<script>
    // é »è­œåœ–åƒæ•¸å€å¡Šå±•é–‹/æ”¶åˆåŠŸèƒ½
    function toggleSpecParams() {
        const content = document.getElementById('specParamsContent');
        const icon = document.getElementById('toggleIcon');
        content.classList.toggle('collapsed');
        icon.classList.toggle('collapsed');
    }

    // é »è­œé¡å‹å°æ‡‰çš„èªªæ˜æ–‡å­—
    const specTypeDescriptions = {
        'mel': 'èª¿æ•´ Mel é »è­œåœ–çš„é€²éšåƒæ•¸ï¼Œå½±éŸ¿é »è­œåœ–çš„è§£æåº¦èˆ‡ç²¾ç¢ºåº¦ã€‚',
        'stft': 'èª¿æ•´çŸ­æ™‚è·å‚…ç«‹è‘‰é »è­œçš„é€²éšåƒæ•¸ã€‚',
        'yamnet_log_mel': 'YAMNet ä½¿ç”¨å›ºå®šçš„é è¨“ç·´åƒæ•¸ (16kHz, 64 Mel bands)ã€‚',
        'classic_demon': 'DEMON é »è­œä½¿ç”¨é è¨­åƒæ•¸ (2-7.5kHz å¸¶é€šæ¿¾æ³¢)ã€‚',
        'envelope_spectrum': 'åŒ…çµ¡ç·šé »è­œä½¿ç”¨é è¨­åƒæ•¸é€²è¡Œåˆ†æã€‚'
    };

    // æ ¹æ“šé »è­œé¡å‹å‹•æ…‹é¡¯ç¤º/éš±è—ç›¸é—œåƒæ•¸
    document.addEventListener('DOMContentLoaded', function () {
        const specTypeSelect = document.getElementById('spec_type');
        const paramsSection = document.getElementById('specParamsSection');
        const paramsDescription = document.getElementById('paramsDescription');
        const paramRows = document.querySelectorAll('.param-row');
        // é¸å–æ‰€æœ‰æœ‰ data-spec-types å±¬æ€§çš„ form-group å…ƒç´ ï¼ˆåµŒå¥—åœ¨ row å…§çš„ç¨ç«‹æ§åˆ¶é …ç›®ï¼‰
        const paramItems = document.querySelectorAll('.form-group[data-spec-types]');

        function updateParamsVisibility() {
            const specType = specTypeSelect.value;

            // æ›´æ–°èªªæ˜æ–‡å­—
            paramsDescription.textContent = specTypeDescriptions[specType] || specTypeDescriptions['mel'];

            // æ›´æ–°åƒæ•¸åˆ—çš„å¯è¦‹æ€§
            paramRows.forEach(row => {
                const allowedTypes = row.getAttribute('data-spec-types');
                if (allowedTypes) {
                    const types = allowedTypes.split(',');
                    const shouldShow = types.includes(specType);
                    row.style.display = shouldShow ? '' : 'none';
                }
            });

            // æ›´æ–°å–®ç¨åƒæ•¸é …ç›®çš„å¯è¦‹æ€§ (åµŒå¥—åœ¨ row å…§çš„)
            paramItems.forEach(item => {
                const allowedTypes = item.getAttribute('data-spec-types');
                if (allowedTypes) {
                    const types = allowedTypes.split(',');
                    const shouldShow = types.includes(specType);
                    // å¾¹åº•éš±è—ï¼Œä¸ä¿ç•™ç©ºé–“
                    item.style.display = shouldShow ? 'block' : 'none';
                }
            });
        }

        specTypeSelect.addEventListener('change', updateParamsVisibility);
        updateParamsVisibility();

        // å¤šæª”æ¡ˆé¸æ“‡é è¦½
        const filesInput = document.getElementById('files');
        const fileListDiv = document.getElementById('fileList');

        filesInput.addEventListener('change', function () {
            fileListDiv.innerHTML = '';
            const files = this.files;

            if (files.length === 0) return;

            const listTitle = document.createElement('div');
            listTitle.className = 'file-list-title';
            listTitle.innerHTML = `<strong>å·²é¸æ“‡ ${files.length} å€‹æª”æ¡ˆï¼š</strong>`;
            fileListDiv.appendChild(listTitle);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'file-list-item';

                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                fileItem.innerHTML = `
                    <span class="file-icon">ğŸµ</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${sizeMB} MB</span>
                `;
                fileListDiv.appendChild(fileItem);
            }
        });
    });
</script>
{% endblock %}